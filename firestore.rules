rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOrgReader(orgId) {
    	return isSignedIn() && (
        request.auth.token['org-' + orgId] == 'Readonly'
        || request.auth.token['org-' + orgId] == 'Member'
        || request.auth.token['org-' + orgId] == 'Admin'
        || request.auth.token.superAdmin == true
      );
    }

    function isOrgMember(orgId) {
    	return isSignedIn() && (
        request.auth.token['org-' + orgId] == 'Member'
        || request.auth.token['org-' + orgId] == 'Admin'
        || request.auth.token.superAdmin == true
      );
    }

    function isOrgAdmin(orgId) {
      return isSignedIn() && (
        request.auth.token['org-' + orgId] == 'Admin'
        || request.auth.token.superAdmin == true
      );
    }

    function hasFields(fields){
      return request.resource.data.keys().hasAny(fields)
    }

    function hasFieldsOnly(fields){
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields)
    }
    function hasFieldsChange(fields){
      return request.resource.data.diff(resource.data).affectedKeys().hasAny(fields)
    }

    // Users
  	match /users/{uid} {
      allow read, create, update: if isSignedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    // Organizations
  	match /orgs/{id} {
      allow read: if isOrgReader(id);
      allow update: if isOrgAdmin(id) && !hasFieldsChange(['slug']);
      allow create, delete: if false;
    }

    // Logs
    match /logs/{id} {
      allow read: if isOrgMember(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId)
      allow update: if isOrgMember(request.resource.data.orgId) && hasFieldsOnly(['canceled']);
      allow delete: if false;
    }

    // Members
  	match /members/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgAdmin(request.resource.data.orgId)
        && !hasFields(['userId', 'role', 'inviteEmail', 'inviteDate']);
      allow update: if !hasFieldsChange(['orgId', 'userId', 'role', 'inviteEmail', 'inviteDate'])
        && (isOrgAdmin(resource.data.orgId)
          || (isSignedIn() && request.auth.uid == resource.data.userId));
      allow delete: if false;

      match /threadStatus/{threadId} {
        function getMember() {
          return get(/databases/$(database)/documents/members/$(id)).data;
        }

        allow read, write: if isSignedIn() && request.auth.uid == getMember().userId;
      }
    }

    // Circles
  	match /circles/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if isOrgMember(resource.data.orgId);
    }

    // Roles
  	match /roles/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if isOrgMember(resource.data.orgId);
    }

    // Threads
    match /threads/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId)
        && !hasFieldsChange(['orgId', 'initiatorMemberId', 'createdAt']);
      allow delete: if false;
    }

    // Activities
    match /activities/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId)
        && request.resource.data.userId == request.auth.uid;
      allow update: if isOrgMember(resource.data.orgId)
        && resource.data.userId == request.auth.uid
        && !hasFieldsChange(['orgId', 'userId', 'createdAt']);
      allow delete: if isOrgAdmin(resource.data.orgId) ||
        (isOrgMember(resource.data.orgId) && resource.data.userId == request.auth.uid);

      // Poll answers
      match /answers/{userId} {
        function getActivity() {
          return get(/databases/$(database)/documents/activities/$(id)).data;
        }
        allow read: if
          // Fix error when activity creation is pending so cannot access it yet
          !exists(/databases/$(database)/documents/activities/$(id))
          || isOrgReader(getActivity().orgId);
        allow create, update: if isOrgMember(getActivity().orgId) && request.auth.uid == userId;
        allow delete: if isOrgMember(getActivity().orgId)
          && (request.auth.uid == userId || request.auth.uid == getActivity().userId);
      }
    }

    // Meetings
    match /meetings/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if false;

      // Meeting steps
      match /steps/{stepId} {
        function getMeeting() {
          return get(/databases/$(database)/documents/meetings/$(id)).data;
        }
        allow read: if isOrgReader(getMeeting().orgId);
        allow write: if isOrgMember(getMeeting().orgId);
      }
    }

    // Meeting templates
    match /meetingTemplates/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if isOrgMember(resource.data.orgId);
    }

    // Tasks
    match /tasks/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if false;
    }

    // Tasks views
    match /tasksViews/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if false;
    }

    // Decisions
    match /decisions/{id} {
      allow read: if isOrgReader(resource.data.orgId);
      allow create: if isOrgMember(request.resource.data.orgId);
      allow update: if isOrgMember(resource.data.orgId) && !hasFieldsChange(['orgId']);
      allow delete: if false;
    }
  }
}